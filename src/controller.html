<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <title>paper-plane controller!</title>
  </head>
  <style media="screen">
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    video {
      display: flex;
    }

    .no-mobile {
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0, .5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .warning {
      font-size: 3rem;
      display: flex;
      color: white;
      font-weight: bold;
    }

    .fs-button{
      background: none;
      box-shadow: none;
      border: none;
      position: absolute;
      top: 0;
      right: 0;
    }

    .invisible {
      display: none;
    }
  </style>
  <body>
    <div class="plane-controller">

    </div>
    <div class="invisible no-mobile" id="no-mobile">
      <p class="warning">Please access the controller on a Smartphone!</p>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
    {
      let socket,
          targetId;

      let touchstartX = 0;
      let touchstartY = 0;
      let touchendX = 0;
      let touchendY = 0;

      const min = -90,
            max = 90;

      const init = () => {

        if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
          console.log(`Mobile device is true!`);
        }else{
          document.getElementById(`no-mobile`).classList.remove(`invisible`);
          //return false;
        }

        foldPaperPlane();

        targetId = getUrlParameter('id');
        if(!targetId){
          return;
        }

        socket = io.connect('/');


        socket.on('sid', ({sid}) => {
          console.log(sid);
          socket.emit(`update`, targetId, {
            message: `connection succesfull`,
            remoteId: sid
          });
        });

        socket.on(`update`, ({message}) => {
          console.log(message);
        });

        window.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
            touchstartY = e.changedTouches[0].screenY;
        }, false);

        window.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            touchendY = e.changedTouches[0].screenY;
            handleGesture();
        }, false);
      };

      const foldPaperPlane = () => {
        const $planeGif = document.getElementById(`plane-gif`);
        $planeGif.pause();
      }
      const handleGesture = () => {
          if (touchendX <= touchstartX) {
            socket.emit('update', targetId, {
              gestureX: `left`,
              y: touchendY
            });
          }

          if (touchendX >= touchstartX) {
            socket.emit('update', targetId, {
              gestureX: `right`
            });
          }
      }

      const getUrlParameter = name => {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? false : decodeURIComponent(results[1].replace(/\+/g, ' '));
      };

      init();
      }
    </script>
  </body>
</html>
